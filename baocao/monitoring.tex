% -----------------------------------------------------------------
% 7.1 Monitoring
%
% VƒÉn phong: K·ªπ s∆∞ MLOps - t·∫≠p trung v√†o observability, metrics, alerting
% T·ªï ch·ª©c: System Metrics ‚Üí Data Metrics ‚Üí Alerting ‚Üí Decision Framework

\textit{Monitoring l√† th√†nh ph·∫ßn kh√¥ng th·ªÉ thi·∫øu trong v√≤ng ƒë·ªùi v·∫≠n h√†nh h·ªá th·ªëng g·ª£i √Ω.
B√™n c·∫°nh vi·ªác ƒë·∫£m b·∫£o \textbf{service availability} v√† \textbf{performance SLA},
monitoring c√≤n ƒë√≥ng vai tr√≤ then ch·ªët trong vi·ªác ph√°t hi·ªán \textbf{data drift} ---
hi·ªán t∆∞·ª£ng ph√¢n ph·ªëi d·ªØ li·ªáu thay ƒë·ªïi theo th·ªùi gian khi·∫øn m√¥ h√¨nh m·∫•t hi·ªáu qu·∫£.
Ph·∫ßn n√†y tr√¨nh b√†y chi ti·∫øt c√°c ch·ªâ s·ªë gi√°m s√°t v√† c∆° ch·∫ø c·∫£nh b√°o, ƒë∆∞·ª£c implement trong
\texttt{alerting.py}, \texttt{automation/drift\_detection.py}, v√† \texttt{service/dashboard.py}.}

% ===================================================================
\subsubsection*{System Metrics: Gi√°m s√°t hi·ªáu nƒÉng d·ªãch v·ª•}
% ===================================================================

System metrics ƒëo l∆∞·ªùng tr·ª±c ti·∫øp h√†nh vi c·ªßa service ·ªü m·ª©c infrastructure,
cho ph√©p ph√°t hi·ªán s·ªõm c√°c v·∫•n ƒë·ªÅ v·ªÅ t·∫£i, l·ªói, v√† t·∫Øc ngh·∫Ωn.

\paragraph{Latency Quantiles.}

ƒê·ªô tr·ªÖ ph·∫£n h·ªìi ƒë∆∞·ª£c theo d√µi qua c√°c quantile:
\begin{itemize}
  \item \textbf{P50} (median): Latency ``ƒëi·ªÉn h√¨nh'' m√† ng∆∞·ªùi d√πng tr·∫£i nghi·ªám.
  \item \textbf{P90}: 90\% requests ho√†n th√†nh nhanh h∆°n gi√° tr·ªã n√†y.
  \item \textbf{P95}: Ch·ªâ s·ªë SLA ch√≠nh --- target $< 100$ms.
  \item \textbf{P99}: Ph√°t hi·ªán ``tail latency'' b·∫•t th∆∞·ªùng.
\end{itemize}

C√¥ng th·ª©c t√≠nh percentile $P_k$ t·ª´ t·∫≠p quan s√°t $\{x_1, \dots, x_n\}$ (ƒë√£ s·∫Øp x·∫øp):
\[
  P_k = x_{\lceil k \cdot n / 100 \rceil}
\]

Ng∆∞·ª°ng c·∫£nh b√°o ƒë∆∞·ª£c c·∫•u h√¨nh trong \texttt{config/alerts\_config.yaml}:

\begin{center}
\begin{tabular}{|l|c|c|c|}
\hline
\textbf{Metric} & \textbf{Warning} & \textbf{Critical} & \textbf{Window} \\
\hline
\texttt{avg\_latency\_ms} & $> 200$ms & $> 400$ms & 5 min \\
\texttt{p95\_latency\_ms} & --- & $> 500$ms & 5 min \\
\hline
\end{tabular}
\end{center}

\paragraph{Error Rate.}

T·ª∑ l·ªá l·ªói ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a l√† ph·∫ßn trƒÉm requests tr·∫£ v·ªÅ HTTP 4xx/5xx:
\[
  \text{Error Rate} = \frac{|\{r : r.\text{status} \geq 400\}|}{|\text{total requests}|}
\]

Ng∆∞·ª°ng:
\begin{itemize}
  \item \textbf{Warning}: Error rate $> 1\%$ trong c·ª≠a s·ªï 5 ph√∫t.
  \item \textbf{Critical}: Error rate $> 5\%$ --- trigger incident response.
\end{itemize}

\paragraph{Fallback Rate.}

T·ª∑ l·ªá requests ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi fallback path (content-based thay v√¨ CF):
\[
  \text{Fallback Rate} = \frac{|\{r : r.\text{fallback} = \text{true}\}|}{|\text{total requests}|}
\]

V·ªõi thi·∫øt k·∫ø h·ªá th·ªëng (91.4\% cold-start users), fallback rate k·ª≥ v·ªçng $\approx 91\%$.
N·∫øu fallback rate $> 95\%$ --- c√≥ th·ªÉ CF model b·ªã l·ªói ho·∫∑c mapping kh√¥ng ƒë·ªìng b·ªô.

\paragraph{Throughput.}

S·ªë requests ƒë∆∞·ª£c x·ª≠ l√Ω m·ªói ph√∫t (\texttt{requests\_per\_minute}):
\begin{itemize}
  \item \textbf{Target}: $\geq 100$ req/s (6,000 req/min).
  \item \textbf{Alert}: $< 50$ req/s trong gi·ªù cao ƒëi·ªÉm.
  \item \textbf{Low traffic}: 0 requests trong 5 ph√∫t --- ki·ªÉm tra upstream.
\end{itemize}

% ===================================================================
\subsubsection*{Data Metrics: Ph√°t hi·ªán tr√¥i d·∫°t d·ªØ li·ªáu (Data Drift)}
% ===================================================================

Data drift l√† hi·ªán t∆∞·ª£ng ph√¢n ph·ªëi d·ªØ li·ªáu thay ƒë·ªïi theo th·ªùi gian, khi·∫øn m√¥ h√¨nh
ƒë∆∞·ª£c hu·∫•n luy·ªán tr√™n d·ªØ li·ªáu c≈© tr·ªü n√™n k√©m hi·ªáu qu·∫£ tr√™n d·ªØ li·ªáu m·ªõi.
H·ªá th·ªëng gi√°m s√°t 4 lo·∫°i drift ch√≠nh.

\paragraph{Rating Distribution Drift.}

H·ªá th·ªëng so s√°nh ph√¢n ph·ªëi rating gi·ªØa d·ªØ li·ªáu l·ªãch s·ª≠ (baseline) v√† d·ªØ li·ªáu hi·ªán t·∫°i.
T·ª´ \texttt{drift\_detection.py}, s·ª≠ d·ª•ng t·ªïng hi·ªáu ph√¢n ph·ªëi:
\[
  \text{total\_diff} = \sum_{r=1}^{5} |P_{\text{current}}(r) - P_{\text{baseline}}(r)|
\]

\textbf{Quy t·∫Øc quy·∫øt ƒë·ªãnh} (t·ª´ config):
\begin{itemize}
  \item Ng∆∞·ª°ng: \texttt{rating\_dist\_threshold = 0.1}
  \item N·∫øu \texttt{total\_diff} $> 0.1$: Drift ƒë∆∞·ª£c ph√°t hi·ªán $\rightarrow$ xem x√©t retrain.
\end{itemize}

\begin{verbatim}
result = detect_rating_drift(current_stats, baseline_stats, logger)
# Output: {'metric': 'rating_distribution', 
#          'drift_detected': True, 'total_difference': 0.15,
#          'details': {'rating_5_diff': 0.08, ...}}
\end{verbatim}

\paragraph{Popularity Shift.}

S·ª≠ d·ª•ng \textbf{Jaccard similarity} ƒë·ªÉ so s√°nh top-20 items ph·ªï bi·∫øn nh·∫•t:
\[
  \text{Jaccard} = \frac{|\text{Top20}_{\text{current}} \cap \text{Top20}_{\text{baseline}}|}
                        {|\text{Top20}_{\text{current}} \cup \text{Top20}_{\text{baseline}}|}, \quad
  \text{shift} = 1 - \text{Jaccard}
\]

\textbf{Ng∆∞·ª°ng} (t·ª´ \texttt{DRIFT\_CONFIG}):
\begin{itemize}
  \item \texttt{popularity\_shift\_threshold = 0.2}
  \item N·∫øu \texttt{shift} $> 0.2$ --- popularity distribution ƒë√£ thay ƒë·ªïi ƒë√°ng k·ªÉ,
        c√≥ th·ªÉ do xu h∆∞·ªõng m·ªõi, m√πa v·ª•, ho·∫∑c viral products.
\end{itemize}

\begin{verbatim}
result = detect_popularity_drift(current, baseline, logger)
# Output: {'metric': 'popularity_distribution',
#          'drift_detected': False, 'jaccard_similarity': 0.85,
#          'shift': 0.15, 'details': {'new_items': [...]}}
\end{verbatim}

\paragraph{Interaction Rate Drift.}

Theo d√µi thay ƒë·ªïi trong h√†nh vi ng∆∞·ªùi d√πng th√¥ng qua t·ª∑ l·ªá t∆∞∆°ng t√°c trung b√¨nh:
\begin{itemize}
  \item \textbf{avg\_interactions\_per\_user}: T·ª´ \texttt{data\_stats.json}
  \item \textbf{Change rate}: $\Delta = |\mu_{\text{current}} - \mu_{\text{baseline}}| / \mu_{\text{baseline}}$
\end{itemize}

\textbf{Ng∆∞·ª°ng}:
\[
  \texttt{interaction\_rate\_threshold} = 0.3 \quad (30\%)
\]

N·∫øu $\Delta > 0.3$: Interaction behavior ƒë√£ drift ƒë√°ng k·ªÉ.

\begin{verbatim}
result = detect_interaction_drift(current, baseline, logger)
# Output: {'metric': 'interaction_rate', 'drift_detected': False,
#          'current_rate': 14.2, 'baseline_rate': 13.8,
#          'change_rate': 0.029}
\end{verbatim}

\paragraph{Embedding Freshness.}

\textbf{Vietnamese Embedding} (\texttt{AITeamVN/Vietnamese\_Embedding}, 1024 dim) c·∫ßn ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªãnh k·ª≥ ƒë·ªÉ ph·∫£n √°nh:
\begin{itemize}
  \item S·∫£n ph·∫©m m·ªõi ƒë∆∞·ª£c th√™m v√†o catalog.
  \item M√¥ t·∫£ s·∫£n ph·∫©m ƒë∆∞·ª£c c·∫≠p nh·∫≠t (ingredients, features).
  \item C·∫£i ti·∫øn trong pre-trained model (n·∫øu c√≥).
\end{itemize}

\textbf{Ch·ªâ s·ªë freshness} (t·ª´ \texttt{alerts\_config.yaml}):
\[
  \text{Age}_{\text{days}} = \lfloor \text{now} - \text{embeddings.created\_at} \rfloor
\]

\textbf{Ng∆∞·ª°ng}: \texttt{embedding\_age\_days = 30} $\rightarrow$ Embeddings ƒë∆∞·ª£c coi l√† \textit{stale}.

\textbf{Embedding Drift Detection}:
Khi regenerate embeddings, so s√°nh v·ªõi version c≈© b·∫±ng cosine similarity:
\[
  \text{sim}(i) = \frac{\mathbf{e}_i^{\text{old}} \cdot \mathbf{e}_i^{\text{new}}}
                      {\|\mathbf{e}_i^{\text{old}}\| \|\mathbf{e}_i^{\text{new}}\|}
\]

N·∫øu $\text{mean}(\text{sim}) < 0.95$: Embeddings ƒë√£ drift ƒë√°ng k·ªÉ --- c·∫ßn retrain CF model (BERT-ALS).

% ===================================================================
\subsubsection*{Comprehensive Drift Report (t·ª´ \texttt{generate\_drift\_report()})}
% ===================================================================

H·ªá th·ªëng t·ªïng h·ª£p t·∫•t c·∫£ drift checks v√†o m·ªôt report ƒë·ªãnh k·ª≥ (weekly), l∆∞u t·∫°i 
\texttt{reports/drift/drift\_report\_YYYYMMDD\_HHMMSS.json}:

\begin{verbatim}
{
  "generated_at": "2025-11-27T10:00:00",
  "git_commit": "abc123",
  "drift_detected": true,
  "results": [
    {
      "metric": "rating_distribution",
      "drift_detected": true,
      "total_difference": 0.15,
      "threshold": 0.1
    },
    {
      "metric": "popularity_distribution", 
      "drift_detected": false,
      "jaccard_similarity": 0.85,
      "shift": 0.15,
      "threshold": 0.2
    },
    {
      "metric": "interaction_rate",
      "drift_detected": false,
      "change_rate": 0.029,
      "threshold": 0.3
    }
  ]
}
\end{verbatim}

Quy t·∫Øc t·ªïng h·ª£p:
\[
  \text{drift\_detected} = \bigvee_{\text{result } r} r.\text{drift\_detected}
\]

\paragraph{CLI Usage:}
\begin{verbatim}
# Run drift detection
python -m automation.drift_detection

# Update baseline after confirmed changes
python -m automation.drift_detection --update-baseline
\end{verbatim}

% ===================================================================
\subsubsection*{Alerting System}
% ===================================================================

H·ªá th·ªëng alerting h·ªó tr·ª£ 3 channels: \textbf{Log}, \textbf{Email}, v√† \textbf{Slack},
v·ªõi severity levels: \texttt{info}, \texttt{warning}, \texttt{critical}.

\paragraph{Alert Definitions (t·ª´ \texttt{alerts\_config.yaml}).}

\begin{center}
\begin{tabular}{|l|l|l|l|}
\hline
\textbf{Alert} & \textbf{Condition} & \textbf{Severity} & \textbf{Action} \\
\hline
\texttt{high\_latency} & $\text{avg\_latency} > 200$ms & warning & log \\
\texttt{critical\_latency} & $\text{p95\_latency} > 500$ms & critical & email+slack \\
\texttt{high\_error\_rate} & $\text{error\_rate} > 5\%$ & critical & email+slack \\
\texttt{high\_fallback\_rate} & $\text{fallback} > 95\%$ & warning & log \\
\texttt{low\_traffic} & $\text{requests\_per\_minute} = 0$ & warning & log \\
\texttt{data\_drift} & drift\_detected = true & info & email \\
\hline
\end{tabular}
\end{center}

\paragraph{AlertManager Class (t·ª´ \texttt{alerting.py}).}

\begin{verbatim}
class AlertManager:
    def send_alert(self, subject, message, severity, metadata=None):
        # Log to logs/service/alerts.log
        # Email for warning/critical (if enabled)
        # Slack for warning/critical (if enabled)
        
    def check_alert_conditions(self, metrics, model_id):
        # Check all thresholds from config
        # Return list of triggered alerts
\end{verbatim}

\paragraph{Alert Cooldown.}

ƒê·ªÉ tr√°nh alert fatigue, √°p d·ª•ng cooldown period:
\[
  \text{send\_alert} = (\text{now} - \text{last\_alert\_time}) > T_{\text{cooldown}}
\]
v·ªõi $T_{\text{cooldown}} = 30$ ph√∫t cho c√πng m·ªôt lo·∫°i alert.

\paragraph{Alert Template (t·ª´ \texttt{templates} section).}

\begin{verbatim}
üö® Critical Error Rate Alert

Current error rate: {value:.1%}
Threshold: {threshold:.1%}
Errors in last 5 minutes: {error_count}
Model: {model_id}

Action Required: Check service logs for errors.
\end{verbatim}

\paragraph{Convenience Functions (t·ª´ \texttt{alerting.py}):}
\begin{verbatim}
# Send alert using singleton AlertManager
from alerting import (send_alert, alert_high_latency, 
                       alert_high_error_rate, alert_data_drift,
                       alert_model_performance)

send_alert("High Latency", "P95 = 250ms", severity="warning")
alert_high_latency(latency_ms=250, threshold=200)
alert_high_error_rate(error_rate=0.08, threshold=0.05)
alert_data_drift(drift_result={'drift_detected': True, 'p_value': 0.02})
alert_model_performance(current_recall=0.18, baseline_recall=0.22, 
                        threshold_drop=0.1)
\end{verbatim}

% ===================================================================
\subsubsection*{Retrain Decision Framework}
% ===================================================================

Quy·∫øt ƒë·ªãnh retrain ƒë∆∞·ª£c ƒë∆∞a ra d·ª±a tr√™n t·ªïng h·ª£p nhi·ªÅu t√≠n hi·ªáu (t·ª´ \texttt{retrain\_triggers} trong config):

\begin{enumerate}
  \item \textbf{Rating Drift}: Total distribution difference $> 0.1$.
  \item \textbf{Popularity Shift}: Jaccard similarity $< 0.8$ (shift $> 0.2$).
  \item \textbf{Interaction Rate Change}: Change rate $> 30\%$.
  \item \textbf{Data Staleness}: Training data $> 30$ ng√†y tu·ªïi.
  \item \textbf{Embedding Staleness}: Vietnamese Embeddings $> 30$ ng√†y tu·ªïi.
  \item \textbf{Performance Drop}: CTR gi·∫£m $> 10\%$ so v·ªõi baseline.
\end{enumerate}

\textbf{Decision Rule}:
\[
  \text{should\_retrain} = \bigvee_{i=1}^{6} \text{trigger}_i
\]

N·∫øu b·∫•t k·ª≥ trigger n√†o active $\rightarrow$ ƒë∆∞a ra khuy·∫øn ngh·ªã retrain k√®m l√Ω do c·ª• th·ªÉ.

\begin{verbatim}
# From alerts_config.yaml
retrain_triggers:
  rating_drift_pvalue: 0.05
  popularity_correlation: 0.8
  data_age_days: 30
  ctr_drop_percent: 10
  embedding_age_days: 30
\end{verbatim}

% ===================================================================
\subsubsection*{Dashboard v√† Visualization (\texttt{service/dashboard.py})}
% ===================================================================

H·ªá th·ªëng cung c·∫•p Streamlit dashboard v·ªõi 5 tabs ch√≠nh:

\begin{enumerate}
  \item \textbf{Service Health}: Real-time latency, error rate, fallback rate, requests/minute charts.
  \item \textbf{Training History}: L·ªãch s·ª≠ training runs, model performance comparison (bar charts).
  \item \textbf{Scheduler}: Qu·∫£n l√Ω scheduled jobs (enable/disable, run now, view logs).
  \item \textbf{Drift Detection}: K·∫øt qu·∫£ drift checks, trend visualization.
  \item \textbf{Model Info}: Th√¥ng tin model ƒëang serve, registry status.
\end{enumerate}

\paragraph{Data Sources:}
\begin{itemize}
  \item \textbf{Training DB}: \texttt{logs/training\_metrics.db} (SQLite) --- l∆∞u training runs (table \texttt{training\_runs}) v√† iteration metrics (table \texttt{iteration\_metrics} v·ªõi c√°c c·ªôt \texttt{run\_id}, \texttt{iteration}, \texttt{loss}, \texttt{validation\_ndcg})
  \item \textbf{Service DB}: \texttt{logs/service\_metrics.db} (SQLite) --- l∆∞u request logs (table \texttt{requests}) v√† health metrics (table \texttt{service\_health})
  \item \textbf{API}: \texttt{/scheduler/status}, \texttt{/scheduler/jobs} --- real-time scheduler status
\end{itemize}

Dashboard h·ªó tr·ª£:
\begin{itemize}
  \item \textbf{Time range selection}: Last 15min / 1h / 6h / 24h.
  \item \textbf{Auto-refresh}: T·ª± ƒë·ªông c·∫≠p nh·∫≠t m·ªói 10 gi√¢y (configurable).
  \item \textbf{Interactive charts}: Line charts cho metrics time series, bar charts cho model comparison.
\end{itemize}

\paragraph{K·∫øt n·ªëi API:}
\begin{verbatim}
API_BASE_URL = os.environ.get("API_URL", "http://viecomrec-api:8000")
# Docker: viecomrec-api:8000
# Local: localhost:8000
\end{verbatim}

% ===================================================================
\subsubsection*{Check Intervals v√† Scheduling (t·ª´ \texttt{alerts\_config.yaml})}
% ===================================================================

\begin{center}
\begin{tabular}{|l|l|l|}
\hline
\textbf{Check Type} & \textbf{Interval} & \textbf{Rationale} \\
\hline
Health check & 60 gi√¢y & Ph√°t hi·ªán nhanh service issues \\
Drift detection & 168 gi·ªù (weekly) & Tr√°nh false positives t·ª´ noise \\
Embedding freshness & 24 gi·ªù (daily) & Ki·ªÉm tra ƒë·ªãnh k·ª≥ \\
Alert cooldown & 30 ph√∫t & Gi·∫£m alert fatigue \\
\hline
\end{tabular}
\end{center}

\paragraph{Configuration (t·ª´ \texttt{intervals} section):}
\begin{verbatim}
intervals:
  health_check_seconds: 60
  drift_check_hours: 168
  alert_cooldown_minutes: 30
\end{verbatim}

L·ªãch tr√¨nh monitoring ƒë∆∞·ª£c t√≠ch h·ª£p v·ªõi Automation Pipeline (m·ª•c 7.2)
ƒë·ªÉ t·ª± ƒë·ªông trigger retrain khi drift ƒë∆∞·ª£c ph√°t hi·ªán.

\paragraph{L∆∞u √Ω v·ªÅ Embedding Models:}
Ki·ªÉm tra freshness cho Vietnamese Embedding (1024 dim) v·ªõi ng∆∞·ª°ng 30 ng√†y.
Chi ti·∫øt v·ªÅ s·ª± ph√¢n bi·ªát v·ªõi ViSoBERT ƒë∆∞·ª£c tr√¨nh b√†y t·∫°i \textbf{m·ª•c 3.0.3.4}.
